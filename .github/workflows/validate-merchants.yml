name: Validate Merchants

on:
  pull_request:
    paths:
      - 'Merchants/merchants.kdl'
      - 'Merchants/schema.kdl'
      - 'Scripts/generate-merchants/**'
  push:
    branches:
      - main
    paths:
      - 'Merchants/merchants.kdl'
      - 'Merchants/schema.kdl'
      - 'Scripts/generate-merchants/**'

jobs:
  validate:
    name: Validate Merchant Database
    runs-on: macos-15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer
      
      - name: Show Xcode version
        run: xcodebuild -version
      
      - name: Set up mise
        uses: jdx/mise-action@v2
        with:
          experimental: true
      
      - name: Validate KDL syntax
        run: mise run validate-merchants
      
      - name: Generate Swift code
        run: mise run generate-merchants
      
      - name: Check for duplicate merchant IDs
        run: |
          duplicates=$(grep -o 'id="[^"]*"' Merchants/merchants.kdl | sort | uniq -d)
          if [ -n "$duplicates" ]; then
            echo "Error: Duplicate merchant IDs found:"
            echo "$duplicates"
            exit 1
          fi
          echo "No duplicate merchant IDs found"
      
      - name: Verify generated code compiles
        run: |
          if [ ! -f "kartonche/Generated/MerchantTemplates.swift" ]; then
            echo "Error: MerchantTemplates.swift was not generated"
            exit 1
          fi
          echo "Generated code exists"
