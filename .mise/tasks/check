#!/usr/bin/env bash
#MISE description="Clean build and show all warnings/errors"

set -euo pipefail

# Use environment variables with sensible defaults
DEVICE="${IOS_DEVICE:-iPhone 16 Pro}"
OS_VERSION="${IOS_VERSION:-26.2}"
ARCH="${IOS_ARCH:-arm64}"
DESTINATION="platform=iOS Simulator,name=$DEVICE,OS=$OS_VERSION,arch=$ARCH"

echo "üßπ Cleaning build artifacts..."
xcodebuild clean \
  -project "$PROJECT" \
  -scheme "$SCHEME" \
  -configuration "$CONFIGURATION" \
  -destination "$DESTINATION" \
  >/dev/null 2>&1

echo "üîç Running clean build to check for warnings and errors..."
echo ""

# Clean build with xcbeautify's --quiet flag
# This will only show tasks that have warnings or errors
set +e
xcodebuild \
  -project "$PROJECT" \
  -scheme "$SCHEME" \
  -configuration "$CONFIGURATION" \
  -destination "$DESTINATION" \
  -quiet \
  build 2>&1 | xcbeautify --quiet

BUILD_EXIT_CODE=${PIPESTATUS[0]}
set -e

echo ""
if [ $BUILD_EXIT_CODE -eq 0 ]; then
  echo "‚úÖ Check passed - no errors found"
else
  echo "‚ùå Check failed - build errors detected"
  exit $BUILD_EXIT_CODE
fi
