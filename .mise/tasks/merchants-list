#!/usr/bin/env bash
#MISE description="List all merchants in the database"

set -euo pipefail

if [ ! -f "$MERCHANTS_FILE" ]; then
  echo "âŒ Merchant database not found: $MERCHANTS_FILE"
  echo "Run mise run merchant-add to create the first merchant"
  exit 1
fi

echo "ðŸ“‹ Merchants in database:"
echo ""

if [ -n "${1:-}" ]; then
  # Filter by category
  category="$1"
  echo "Category: $category"
  echo ""
  grep -B1 "category \"$category\"" "$MERCHANTS_FILE" | grep 'id=' | sed 's/.*id="\(.*\)".*/  - \1/' || echo "  (none found)"
  echo ""
  count=$(grep -B1 "category \"$category\"" "$MERCHANTS_FILE" 2>/dev/null | grep -c 'id=' || echo "0")
  echo "Total: $count merchants"
else
  # List all
  grep -o 'id="[^"]*"' "$MERCHANTS_FILE" | sed 's/id="\(.*\)"/  - \1/'
  echo ""
  echo "Total: $(grep -c 'merchant id=' "$MERCHANTS_FILE") merchants"
fi
