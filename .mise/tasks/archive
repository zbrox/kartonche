#!/usr/bin/env bash
#MISE description="Archive the app for distribution"

set -euo pipefail

ARCHIVE_PATH="build/kartonche.xcarchive"

echo "Archiving kartonche for distribution..."

rm -rf "$ARCHIVE_PATH"

set +e
BUILD_LOG="/tmp/xcodebuild-archive-$$.log"
xcodebuild archive \
  -project "$PROJECT" \
  -scheme "$SCHEME" \
  -archivePath "$ARCHIVE_PATH" \
  -destination 'generic/platform=iOS' \
  -allowProvisioningUpdates 2>&1 | tee "$BUILD_LOG" | xcbeautify

BUILD_EXIT_CODE=${PIPESTATUS[0]}
set -e

if [ $BUILD_EXIT_CODE -eq 0 ]; then
  echo ""
  echo "Archive succeeded: $ARCHIVE_PATH"
  rm -f "$BUILD_LOG"
else
  echo ""
  echo "Archive failed with exit code $BUILD_EXIT_CODE"
  if [ -f "$BUILD_LOG" ]; then
    grep -i "error:" "$BUILD_LOG" | head -20 || echo "No 'error:' lines found"
  fi
  rm -f "$BUILD_LOG"
  exit $BUILD_EXIT_CODE
fi
