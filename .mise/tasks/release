#!/usr/bin/env bash
#MISE description="Create a new release with auto-versioning"

set -euo pipefail

echo "üöÄ Starting release process..."
echo ""

# Step 1: Detect current version
CURRENT_VERSION=$(grep -m 1 "MARKETING_VERSION = " kartonche.xcodeproj/project.pbxproj | sed 's/.*= \(.*\);/\1/')

# Step 2: Calculate next version
YEAR_MONTH=$(echo $CURRENT_VERSION | cut -d. -f1-2)
PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)
TODAY_YEAR_MONTH=$(date +"%Y.%m")

if [ "$YEAR_MONTH" = "$TODAY_YEAR_MONTH" ]; then
    NEXT_PATCH=$((PATCH + 1))
    NEXT_VERSION="$YEAR_MONTH.$NEXT_PATCH"
else
    NEXT_VERSION="$TODAY_YEAR_MONTH.1"
fi

echo "Current version: $CURRENT_VERSION"
echo "Next version: $NEXT_VERSION"
echo ""

# Step 3: Confirm
read -p "Proceed with version $NEXT_VERSION? (y/n) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "‚ùå Release cancelled"
    exit 1
fi

# Step 4: Add What's New entry if not already present
if grep -q "version: \"$NEXT_VERSION\"" kartonche/Models/WhatsNewData.swift; then
    echo "‚úÖ What's New entry for $NEXT_VERSION already exists, skipping"
else
    echo ""
    echo "üìù Opening What's New editor for v$NEXT_VERSION..."
    echo "   Recent feat: commits since last release:"

    LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
    if [ -n "$LAST_TAG" ]; then
        git log $LAST_TAG..HEAD --oneline --grep="^feat" --format="   - %s" | head -10
    fi

    # Create template
    TEMPLATE="/tmp/whats-new-$NEXT_VERSION.txt"
    cat > "$TEMPLATE" << TEMPLATE_EOF
# What's New for version $NEXT_VERSION
# Edit the 3 features below
# Format: icon|titleEN|titleBG|descEN|descBG
#
# Example:
# hand.draw|Swipe Actions|–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –ø–ª—ä–∑–≥–∞–Ω–µ|Swipe cards to favorite, edit, or delete|–ü–ª—ä–∑–Ω–µ—Ç–µ –∫–∞—Ä—Ç–∏ –∑–∞ –±—ä—Ä–∑–æ –æ–∑–Ω–∞—á–∞–≤–∞–Ω–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ –∏–ª–∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ

TEMPLATE_EOF

    # Open editor
    ${EDITOR:-nano} "$TEMPLATE"

    # Validate template has content
    if ! grep -q '^[^#]' "$TEMPLATE"; then
        echo "‚ùå No features added to What's New template"
        exit 1
    fi

    echo ""
    echo "‚úÖ What's New template saved"

    # Step 5: Update WhatsNewData.swift
    echo "üì± Updating What's New in app..."

    # Read features from template (skip comments and empty lines)
    FEATURES=""
    while IFS='|' read -r icon titleEN titleBG descEN descBG; do
        # Skip comments and empty lines
        [[ "$icon" =~ ^# ]] && continue
        [[ -z "$icon" ]] && continue

        FEATURES+="            WhatsNewFeature(
                icon: \"$icon\",
                titleEN: \"$titleEN\",
                titleBG: \"$titleBG\",
                descriptionEN: \"$descEN\",
                descriptionBG: \"$descBG\"
            ),
"
    done < <(grep -v '^#' "$TEMPLATE" | grep -v '^$')

    if [ -z "$FEATURES" ]; then
        echo "‚ùå No valid features found in template"
        exit 1
    fi

    # Create new version entry
    NEW_ENTRY="    WhatsNewVersion(
        version: \"$NEXT_VERSION\",
        features: [
$FEATURES        ]
    ),"

    # Insert before first existing WhatsNewVersion
    TEMP_FILE=$(mktemp)
    awk -v new_entry="$NEW_ENTRY" '
        /let whatsNewVersions: \[WhatsNewVersion\] = \[/ {
            print
            print new_entry
            next
        }
        { print }
    ' kartonche/Models/WhatsNewData.swift > "$TEMP_FILE"

    mv "$TEMP_FILE" kartonche/Models/WhatsNewData.swift

    echo "   Added What's New entry"
fi

# Step 5: Update Xcode project version
echo "üî¢ Updating version to $NEXT_VERSION..."
sed -i '' "s/MARKETING_VERSION = $CURRENT_VERSION;/MARKETING_VERSION = $NEXT_VERSION;/g" \
    kartonche.xcodeproj/project.pbxproj

COUNT=$(grep "MARKETING_VERSION = $NEXT_VERSION" kartonche.xcodeproj/project.pbxproj | wc -l | tr -d ' ')
echo "   Updated $COUNT occurrences"

# Step 6: Validate What's New was updated
if ! grep -q "version: \"$NEXT_VERSION\"" kartonche/Models/WhatsNewData.swift; then
    echo "‚ùå Failed to update What's New - version $NEXT_VERSION not found in WhatsNewData.swift"
    exit 1
fi

echo "‚úÖ What's New validation passed"

# Step 8: Verify build
echo "üî® Verifying build..."
if ! mise run build > /dev/null 2>&1; then
    echo "‚ùå Build failed after version update"
    exit 1
fi
echo "‚úÖ Build succeeded"

# Step 9: Commit version bump
echo "üíæ Creating version bump commit..."
jj describe -m "chore(release): bump version to $NEXT_VERSION

Update app version from $CURRENT_VERSION to $NEXT_VERSION

This is an automated release commit."

# Step 10: Tag the version bump commit, then start a new one for CHANGELOG
echo "üè∑Ô∏è  Creating tag v$NEXT_VERSION..."
jj tag set "v$NEXT_VERSION" -r @
jj new

echo "üìã Generating CHANGELOG..."

# Step 12: Generate CHANGELOG
mise run changelog-update

# Step 13: Commit CHANGELOG
echo "üíæ Creating CHANGELOG commit..."
jj describe -m "docs: update CHANGELOG for v$NEXT_VERSION"

# Done!
echo ""
echo "‚úÖ Release v$NEXT_VERSION complete!"
echo ""
echo "Summary:"
echo "  ‚Ä¢ Version: $CURRENT_VERSION ‚Üí $NEXT_VERSION"
echo "  ‚Ä¢ Git tag: v$NEXT_VERSION"
echo "  ‚Ä¢ Commits: 2 (version bump + CHANGELOG)"
echo ""
echo "Next steps:"
echo "  1. Test the app to verify What's New displays correctly"
echo "  2. Push commits: jj git push --all"
echo "  3. Push tag: git push origin v$NEXT_VERSION"
