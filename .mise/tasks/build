#!/usr/bin/env bash
#MISE description="Build the app (Debug configuration)"

set -euo pipefail

# Use environment variables with sensible defaults
DEVICE="${IOS_DEVICE:-iPhone 16 Pro}"
OS_VERSION="${IOS_VERSION:-26.2}"
ARCH="${IOS_ARCH:-arm64}"

# Build full destination spec to avoid "multiple matching destinations" warning
# Include architecture to disambiguate between arm64 and x86_64 simulators
DESTINATION="platform=iOS Simulator,name=$DEVICE,OS=$OS_VERSION,arch=$ARCH"

echo "Building kartonche for $DEVICE (iOS $OS_VERSION)..."
echo ""

# Capture build output and format with xcbeautify
# Don't use -quiet in CI to see all errors
set +e  # Don't exit on build failure, we want to see formatted errors
xcodebuild \
  -project "$PROJECT" \
  -scheme "$SCHEME" \
  -configuration "$CONFIGURATION" \
  -destination "$DESTINATION" \
  build | xcbeautify

BUILD_EXIT_CODE=${PIPESTATUS[0]}
set -e

if [ $BUILD_EXIT_CODE -eq 0 ]; then
  echo ""
  echo "✅ Build succeeded"
else
  echo ""
  echo "❌ Build failed with exit code $BUILD_EXIT_CODE"
  exit $BUILD_EXIT_CODE
fi
